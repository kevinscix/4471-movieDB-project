<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>MovieDB+ Search</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f7f7f7;
        }

        h1 {
            margin-bottom: 1rem;
            color: #222;
        }

        h2 {
            margin: 0 0 0.25rem 0;
        }

        header {
            background: linear-gradient(90deg, #0f172a, #0b63b6);
            color: #fff;
            padding: 1.25rem 2rem 1rem 2rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        header .title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        nav {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        nav a {
            color: #e0ecff;
            text-decoration: none;
            padding: 0.4rem 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 999px;
            font-size: 0.95rem;
        }

        nav a:hover {
            background: rgba(255, 255, 255, 0.12);
        }
        nav a.active {
            background: rgba(255, 255, 255, 0.18);
            color: #fff;
        }

        main {
            padding: 1.5rem 2rem 2rem;
        }

        .panel {
            background: #fff;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .panel-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 0.75rem;
            align-items: center;
        }

        .inline-form {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin: 0;
        }

        .inline-form input[type="text"],
        .inline-form input[type="number"] {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        select {
            padding: 0.7rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            background-color: #0069c0;
            color: #fff;
            cursor: pointer;
        }

        button:hover {
            background-color: #00549a;
        }

        #results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .movie-card {
            padding: 1rem;
            background: #fff;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1rem;
        }

        .status {
            margin: 0.5rem 0 1rem 0;
            color: #444;
        }

        .movie-card img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }

        .note {
            color: #666;
            font-size: 0.9rem;
        }

        .wrap {
            gap: 0.75rem;
        }

        .actions {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.35rem 0.65rem;
            border-radius: 999px;
            background: #eef2ff;
            color: #1f2a44;
            font-size: 0.9rem;
        }

        .pagination {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }

        .poster-link {
            display: block;
        }

        .poster-link img {
            border-radius: 4px;
            transition: transform 0.2s ease;
        }

        .poster-link:hover img {
            transform: scale(1.02);
        }

        .subtle-text {
            color: #666;
            font-size: 0.85rem;
        }
    </style>
</head>

<body>
    <header>
        <div class="title-row">
            <div>
                <h1 style="color: white;">MovieDB+ Dashboard</h1>
                <p>Search, ratings, genres, and box office â€” all in one place.</p>
            </div>
            <nav>
                <a href="/search" class="active">Search</a>
                <a href="/ratings">Ratings</a>
                <a href="/genres">Genres</a>
                <a href="/boxoffice">Box Office</a>
            </nav>
        </div>
    </header>

    <main>
    <section class="panel" id="search">
        <div class="panel-header">
            <div>
                <h2>Search</h2>
                <p>Basic OMDb-backed search with caching.</p>
            </div>
            <form id="search-form" class="inline-form">
                <input id="query" type="text" name="q" maxlength="100" placeholder="Search for a movie" required />
                <input id="search-year" type="text" name="year" maxlength="4" placeholder="Year (optional)" />
                <input id="search-language" type="text" name="language" placeholder="Language (optional)" />
                <select id="search-type" name="type">
                    <option value="">Any type</option>
                    <option value="movie">Movie</option>
                    <option value="series">Series</option>
                    <option value="episode">Episode</option>
                </select>
                <select id="search-per-page" name="per_page">
                    <option value="5">5 per page</option>
                    <option value="10" selected>10 per page</option>
                </select>
                <select id="search-sort" name="sort">
                    <option value="relevance">Relevance</option>
                    <option value="recent">Recent (Year)</option>
                    <option value="rating">Rating</option>
                </select>
                <button type="submit">Search</button>
            </form>
        </div>
        <div class="status" id="status"></div>
        <div class="grid" id="results"></div>
        <div class="pagination" id="search-pagination"></div>
    </section>
    </main>

    <script>
        const $ = (id) => document.getElementById(id);

        const renderCard = (title, body) => {
            const card = document.createElement("div");
            card.className = "movie-card";
            card.innerHTML = `<h3>${title}</h3>${body}`;
            return card;
        };

        const fetchJson = async (url, options = {}) => {
            const res = await fetch(url, options);
            const data = await res.json();
            return { ok: res.ok, data };
        };

        const createPagerButton = (label, disabled, handler) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.textContent = label;
            btn.disabled = disabled;
            if (!disabled && handler) {
                btn.addEventListener("click", handler);
            }
            return btn;
        };

        const renderPaginationControls = (
            container,
            { page = 1, hasPrev = false, hasNext = false, onPrev, onNext }
        ) => {
            if (!container) return;
            container.innerHTML = "";
            if (!hasPrev && !hasNext && page <= 1) return;
            const label = document.createElement("span");
            label.className = "subtle-text";
            label.textContent = `Page ${page}`;
            container.appendChild(label);
            container.appendChild(
                createPagerButton("Previous", !hasPrev, () => onPrev && onPrev())
            );
            container.appendChild(
                createPagerButton("Next", !hasNext, () => onNext && onNext())
            );
        };

        let currentSearchQuery = "";
        let currentSearchPage = 1;
        let currentSearchFilters = { year: "", language: "", type: "", per_page: 10 };

        const loadSearchResults = async (page = 1) => {
            if (!currentSearchQuery) return;
            const status = $("status");
            const container = $("results");
            const pager = $("search-pagination");
            status.textContent = "Searching...";
            container.innerHTML = "";
            pager.innerHTML = "";
            const params = new URLSearchParams({ page: page.toString(), per_page: String(currentSearchFilters.per_page || 10) });
            ["year", "language", "type", "sort"].forEach((key) => {
                const val = currentSearchFilters[key];
                if (val) params.set(key, val);
            });
            const { ok, data } = await fetchJson(
                `/api/search?q=${encodeURIComponent(currentSearchQuery)}&${params.toString()}`
            );
            if (!ok) {
                status.textContent = data.error || "Something went wrong.";
                return;
            }
            currentSearchPage = data.page || page;
            const resultCount = data.results?.length || 0;
            const totalResults = data.total_results ?? resultCount;
            const totalPages = data.total_pages ?? 1;
            status.textContent = data.message
                ? data.message
                : `${resultCount} result(s) on this page of ${totalResults} total (page ${currentSearchPage}/${totalPages})${data.cached ? " (cached)" : ""}.`;
            if (!resultCount) {
                renderPaginationControls(pager, {
                    page: currentSearchPage,
                    hasPrev: data.has_prev,
                    hasNext: data.has_next,
                    onPrev: () => loadSearchResults(currentSearchPage - 1),
                    onNext: () => loadSearchResults(currentSearchPage + 1),
                });
                return;
            }
            (data.results || []).forEach((m) => {
                let poster = "";
                if (m.poster && m.poster !== "N/A") {
                    const image = `<img src="${m.poster}" alt="${m.title} poster" />`;
                    poster = m.imdbID
                        ? `<a class="poster-link" href="/movie/${m.imdbID}/view">${image}</a>`
                        : image;
                }
                container.appendChild(
                    renderCard(`${m.title || "Untitled"} (${m.year || "N/A"})`, `
                        ${poster}
                        <p><strong>Average Rating:</strong> ${m.average_rating ?? "N/A"}</p>
                        <p><strong>IMDb:</strong> ${m.imdbRating || "N/A"}</p>
                        <p><strong>Genres:</strong> ${m.genre || "N/A"}</p>
                        <p><strong>Box Office:</strong> ${m.boxOffice || "N/A"}</p>
                        <p><strong>IMDb ID:</strong> ${m.imdbID || "N/A"}</p>
                        <div class="actions"></div>
                    `)
                );
            });
            renderPaginationControls(pager, {
                page: currentSearchPage,
                hasPrev: data.has_prev,
                hasNext: data.has_next,
                onPrev: () => loadSearchResults(currentSearchPage - 1),
                onNext: () => loadSearchResults(currentSearchPage + 1),
            });
        };

        $("search-form").addEventListener("submit", (e) => {
            e.preventDefault();
            currentSearchQuery = $("query").value.trim();
            if (!currentSearchQuery) return;
            currentSearchFilters = {
                year: $("search-year").value.trim(),
                language: $("search-language").value.trim(),
                type: $("search-type").value,
                per_page: parseInt($("search-per-page").value, 10) || 10,
                sort: $("search-sort").value || "relevance",
            };
            currentSearchPage = 1;
            loadSearchResults(1);
        });

    </script>
</body>

</html>
